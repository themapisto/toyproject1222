<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kdis.demo.dao.MemberDao">
	
	<!-- 마이페이지 회원정보 가져오기 -->
	<select id="selectMyInfo" parameterType="Map" resultType="com.kdis.demo.vo.UserVo">
		select userId, userNm, DATE_FORMAT(birthday,'%Y-%m-%d') as birthday, phoneNumber,
		email,grade,userState,loginFailCount,loginFailTime
		from USER
		where userId = #{userId}
	</select>
	
	<!-- 회원정보 수정 -->
	<update id="updateMyInfo" parameterType="Map">
		update USER
		set userNm = #{userNm}, birthday = #{birthday}, phoneNumber = #{phoneNumber}, email = #{email}
		where userId = #{userId}
	</update>

	<!-- 비밀번호 수정 -->
	<update id="updatePwd" parameterType="Map">
		update USER
		set password = #{password} , salt = #{salt}
		where userId = #{userId}
	</update>
	
	<!-- 회원탈퇴 -->
	<update id="userWithdrawal" parameterType="Map">
		update USER
		set userState = "9"
		where userId = #{userId} and password = #{password}
	</update>
	
		<!-- 계정 상태 변경 -->
	<update id="updateUserState" parameterType="Map">
		update USER
		set userState = #{userState}
		where userId = #{userId}
	</update>
	
	<!-- 쿠폰정보가져오기 -->
	<select id="selectCouponInfo" parameterType="String" resultType="com.kdis.demo.vo.CouponVO">
		select *
		from COUPON
		where couponId = #{couponId}
	</select>
	
	<!-- 쿠폰등록하기 -->
	<insert id="insertCouponRegister" parameterType="Map">
		INSERT INTO usercoupon(couponId,userId,registDt,expireDt,useChk) 
		VALUES (#{couponId},#{userId},NOW(),DATE_ADD(NOW(), INTERVAL #{usePeriod} DAY),"1");
	</insert>
	
	<!-- my쿠폰불러오기 -->
	<select id="selectMyCoupon" parameterType="Map" resultType="com.kdis.demo.vo.UserCouponVO">
		SELECT uc.userId as userId
			, uc.couponId as couponId
			, uc.registDt as registDt
			, uc.expireDt as expireDt
			, uc.useChk as useChk
			, uc.useDt as useDt
			, c.couponNm as couponNm
			, c.dscntRate as dscntRate
		FROM usercoupon uc
		LEFT JOIN coupon c
		ON uc.couponId = c.couponId
		WHERE uc.userId = #{userId}
		ORDER BY registDt DESC, expireDt DESC;
	</select>
	
	<!-- 모든 회원 -->
	<select id="showAllUser" resultType="com.kdis.demo.vo.UserVo" parameterType="com.kdis.demo.vo.PaginationDto">
		select *
		from user
		where grade=1
		<if test="state != ''">
			and userState=#{state}
		</if>
		<if test="state==8 and endDate !=''">
			and loginFailTime between #{startDate} and #{endDate}
		</if>
		<if test="keyword != ''">
			and ${option} like CONCAT('%', #{keyword}, '%')
		</if>
		order by regDt desc
		limit #{startIdx},#{cntPerPage}
	</select>
	
	<!-- 회원 페이징  -->
	<select  id="countTotal" resultType="int" parameterType="com.kdis.demo.vo.PaginationDto">
		select count(*)
		from user
		where grade=1
		<if test="state != ''">
			and userState=#{state}
		</if>
		<if test="state==8 and endDate !=''">
			and loginFailTime between #{startDate} and #{endDate}
		</if>
		<if test="keyword != ''">
			and ${option} like CONCAT('%', #{keyword}, '%')
		</if>
	</select>
	
	<!-- 상태변경  -->
	<update id="modifyState" parameterType="com.kdis.demo.vo.UserVo">
		UPDATE user
		SET userState =#{userState}
		WHERE userId = #{userId}
	</update>
	
	<!-- 모든 관리자 -->
	<select id="showAllAdmin" resultType="com.kdis.demo.vo.UserVo" parameterType="com.kdis.demo.vo.PaginationDto">
		select *
		from user
		where grade=5
		<if test="state != ''">
			and userState=#{state}
		</if>
		<if test="keyword != ''">
			and ${option} like CONCAT('%', #{keyword}, '%')
		</if>	
		order by regDt desc
		limit #{startIdx},#{cntPerPage}
	</select>
	
	<!-- 관리자 페이징  -->
	<select  id="countAdmin" resultType="int" parameterType="com.kdis.demo.vo.PaginationDto">
		select count(*)
		from user
		where grade=5
		<if test="keyword != ''">
			and ${option} like CONCAT('%', #{keyword}, '%')
		</if>
	</select>
	
	<!-- 관리자 삭제  -->
	<delete  id="deleteAdmin" parameterType="com.kdis.demo.vo.UserVo">
		delete 
		from user 
		where userId = #{userId}
	</delete>
	
	<!-- 모든 유저(회원,관리자) -->
	<select id="allUserTable" resultType="Map">
		select *
		from user
		order by grade, userNm
	</select>
	
	<!-- 유저 컬럼이름 -->
	<select id="userColumnName" resultType="String">
		SELECT COLUMN_NAME 
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_SCHEMA = 'movietoyproject' AND TABLE_NAME = 'user';
	</select>
</mapper>